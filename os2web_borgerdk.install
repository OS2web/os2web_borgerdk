<?php

/**
 * @file
 * Install, update and uninstall functions for the os2web_borgerdk module.
 */

use Drupal\Core\Field\BaseFieldDefinition;
use Drupal\Core\Field\FieldStorageDefinitionInterface;
use Drupal\user\Entity\Role;

/**
 * Implements hook_install().
 */
function os2web_borgerdk_install() {
  \Drupal::messenger()->addStatus(__FUNCTION__);

  // Adding access to content for anonymous user.
  $anonym = Role::load('anonymous');
  $anonym->grantPermission('view os2web_borgerdk content');
  $anonym->save();

  // Adding comments permissions for authenticated user.
  $authenticated = Role::load('authenticated');
  $authenticated->grantPermission('view os2web_borgerdk content');
  $authenticated->save();
}

/**
 * Implements hook_uninstall().
 */
function os2web_borgerdk_uninstall() {
  \Drupal::messenger()->addStatus(__FUNCTION__);
}

/**
 * Implements hook_requirements().
 */
function os2web_borgerdk_requirements($phase) {
  $requirements = [];

  if ($phase == 'runtime') {
    $value = mt_rand(0, 100);
    $requirements['os2web_borgerdk_status'] = [
      'title' => t('os2web_borgerdk status'),
      'value' => t('os2web_borgerdk value: @value', ['@value' => $value]),
      'severity' => $value > 50 ? REQUIREMENT_INFO : REQUIREMENT_WARNING,
    ];
  }

  return $requirements;
}

/**
 * Implements hook_update_N().
 *
 * Adding source field.
 */
function os2web_borgerdk_update_8001() {
  $storage_definition = BaseFieldDefinition::create('string')
    ->setLabel(t('Source'))
    ->setDescription(t('The source of Borger.dk content entity.'))
    ->setRequired(TRUE)
    ->setSetting('max_length', 255)
    ->setDisplayOptions('view', [
      'label' => 'above',
      'type' => 'string',
      'weight' => 21,
    ])
    ->setDisplayConfigurable('view', TRUE);

  \Drupal::entityDefinitionUpdateManager()
    ->installFieldStorageDefinition('source', 'os2web_borgerdk_article', 'os2web_borgerdk_article', $storage_definition);

  \Drupal::entityDefinitionUpdateManager()
    ->installFieldStorageDefinition('source', 'os2web_borgerdk_microarticle', 'os2web_borgerdk_microarticle', $storage_definition);

  \Drupal::entityDefinitionUpdateManager()
    ->installFieldStorageDefinition('source', 'os2web_borgerdk_selfservice', 'os2web_borgerdk_selfservice', $storage_definition);
}

/**
 * Implements hook_update_N().
 *
 * Adding permissions for viewing content.
 */
function os2web_borgerdk_update_8002() {
  // Adding access to content for anonymous user.
  $anonym = Role::load('anonymous');
  $anonym->grantPermission('view os2web_borgerdk content');
  $anonym->save();

  // Adding access to content for authenticated user.
  $authenticated = Role::load('authenticated');
  $authenticated->grantPermission('view os2web_borgerdk content');
  $authenticated->save();
}
